<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‡∏£‡∏∞‡∏ö‡∏ö AUTODIDACTIC (Admin)</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>

  <style>
    :root {
      --red-600:#c72828;
      --red-700:#9b1f1f;
      --card-bg:#fff;
      --muted:#666;
    }
    * { box-sizing:border-box }
    body {
      font-family:'Prompt', sans-serif;
      margin:0; padding:0;
      background:linear-gradient(to bottom,#fff,#fdeaea);
      color:#111;
    }

    /* ===== Header ===== */
    header {
      background:linear-gradient(90deg,#c00,#f44336);
      color:#fff;
      padding:12px 20px;
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      flex-wrap:wrap;
      position:sticky; 
      top:0; 
      z-index:10;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
    }
    .logo-title { 
      display:flex; 
      gap:12px; 
      align-items:center; 
    }
    .logo-title img { 
      width:50px; 
      background:rgba(255,255,255,0.8); 
      padding:5px; 
      border-radius:8px; 
    }
    .nav-btn { 
      color:#fff; 
      background:rgba(0,0,0,0.2); 
      padding:8px 12px; 
      border-radius:8px; 
      text-decoration:none; 
      font-weight:700; 
      transition:0.3s;
    }
    .nav-btn:hover { background:rgba(255,255,255,0.3); }

    /* ===== Layout ===== */
    main { 
      max-width:1200px; 
      margin:24px auto; 
      padding:0 16px; 
    }
    .top-actions { 
      margin-bottom:18px; 
      display:flex; 
      gap:12px; 
      align-items:center; 
      flex-wrap:wrap; 
    }
    
    .grid { 
      display:grid; 
      grid-template-columns:repeat(2,1fr); 
      gap:18px; 
    }
    @media(max-width:880px) { 
      .grid { grid-template-columns:1fr; } 
    }

    /* ===== Cards ===== */
    .card {
      background:var(--card-bg);
      border-radius:12px;
      padding:16px;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      border:2px solid rgba(199,40,40,0.08);
    }
    .card h3 { 
      margin:0 0 12px 0; 
      color:var(--red-600); 
      font-size:18px; 
    }

    /* ===== Buttons ===== */
    .btn {
      background:var(--red-600); 
      color:#fff; 
      border:none;
      padding:8px 14px; 
      border-radius:10px; 
      cursor:pointer;
      font-weight:700; 
      font-size:14px;
      box-shadow:0 6px 14px rgba(0,0,0,0.1);
      transition:0.2s;
    }
    .btn:hover { 
      opacity:0.9; 
      transform:translateY(-1px); 
    }
    .btn.danger { background:#ff5050; }
    .btn.secondary { background:#555; }

    /* ===== Text Styles ===== */
    .small-muted { font-size:13px; color:#666; }
    .tiny { font-size:12px; color:#444; }
    .tiny2 { font-size:12px; color:#fff; }

    /* ===== List Items ===== */
    .list-item {
      background:#fff6f6; 
      border:1px solid rgba(199,40,40,0.12);
      padding:10px; 
      border-radius:8px; 
      margin-bottom:10px;
    }
    .action-row { 
      margin-top:8px; 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô #engineerList, #salesList, #managerList */
#eventListPending,
#eventListCompleted,
#leaveList,
#engineerList,
#salesList,
#managerList,
#adminList { /* ‡πÄ‡∏û‡∏¥‡πà‡∏° #adminList */
  max-height: 350px;
  overflow-y: auto;
  padding-right:6px;
}

#eventListPending::-webkit-scrollbar,
#eventListCompleted::-webkit-scrollbar,
#leaveList::-webkit-scrollbar,
#engineerList::-webkit-scrollbar,
#salesList::-webkit-scrollbar,
#managerList::-webkit-scrollbar,
#adminList::-webkit-scrollbar { /* ‡πÄ‡∏û‡∏¥‡πà‡∏° #adminList */
  width:6px; 
}

#eventListPending::-webkit-scrollbar-thumb,
#eventListCompleted::-webkit-scrollbar-thumb,
#leaveList::-webkit-scrollbar-thumb,
#engineerList::-webkit-scrollbar-thumb,
#salesList::-webkit-scrollbar-thumb,
#managerList::-webkit-scrollbar-thumb,
#adminList::-webkit-scrollbar-thumb { /* ‡πÄ‡∏û‡∏¥‡πà‡∏° #adminList */
  background:#c00; 
  border-radius:4px;
}

#eventListPending::-webkit-scrollbar-track,
#eventListCompleted::-webkit-scrollbar-track,
#leaveList::-webkit-scrollbar-track,
#engineerList::-webkit-scrollbar-track,
#salesList::-webkit-scrollbar-track,
#managerList::-webkit-scrollbar-track,
#adminList::-webkit-scrollbar-track { /* ‡πÄ‡∏û‡∏¥‡πà‡∏° #adminList */
  background:#ffe5e5;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏° responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
@media(max-width:1024px) {
  .card div[style*="grid-template-columns:repeat(4"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

@media(max-width:640px) {
  .card div[style*="grid-template-columns:repeat(4"] {
    grid-template-columns: 1fr !important;
  }
}

    /* ===== Inputs ===== */
    input[type="text"], 
    input[type="password"], 
    select {
      padding:8px 10px; 
      border-radius:8px; 
      border:1px solid #ddd;
      font-size:14px;
    }
    .input-row { 
      display:flex; 
      gap:12px; 
      flex-wrap:wrap; 
      align-items:center; 
      margin-bottom:12px; 
    }
    .input-row input { 
      flex:1; 
      min-width:200px; 
    }

    /* ===== Footer ===== */
    footer {
      background:linear-gradient(90deg,#c00,#f44336);
      color:#fff; 
      padding:12px; 
      text-align:center; 
      margin-top:30px;
      box-shadow:0 -3px 6px rgba(0,0,0,0.1);
    }

    /* ===== Calendar ===== */
    #holidayCalendar { min-height:300px; }
  </style>
</head>
<body>

<header>
  <div class="logo-title">
    <img src="ad_logo-Photoroom.png" alt="logo" />
    <div>
      <div style="font-weight:800; font-size:18px;">üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ AUTODIDACTIC (Admin)</div>
      <div class="tiny2">Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</div>
    </div>
  </div>
  <nav>
    <a href="calendar_admin.html" class="nav-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  </nav>
</header>

<main>
  <div class="top-actions">
    <a href="calendar_admin.html" class="btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    <a href="export-csv.html" class="btn secondary">‚¨á Export CSV</a>
    <div style="flex:1"></div>
    <div class="small-muted">¬© 2025 AUTODIDACTIC</div>
  </div>

  <div class="grid">

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
    <section class="card">
      <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</h3>
      <div id="eventListPending" class="small-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤ -->
    <section class="card">
      <h3>üèñ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤</h3>
      <div id="leaveList" class="small-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ -->
    <section class="card">
      <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)</h3>
      <div id="eventListCompleted" class="small-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <!-- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö -->
    <section class="card" style="grid-column:1 / -1;">
  <h3>üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Users)</h3>

  <div class="input-row">
    <input id="userName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (name)" style="flex:2;">
    <input id="userUserId" type="text" placeholder="userId (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÉ‡∏ä‡πâ auto ID)" style="flex:1;">
    <input id="userPassword" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password)" style="flex:1;">
    <select id="userPosition" style="width:150px;">
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
      <option value="engineer">Engineer</option>
      <option value="sales">Sales</option>
      <option value="manager">Manager</option>
      <option value="admin">Admin</option> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
    </select>
    <button id="addUserBtn" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
  </div>
  <div class="tiny" style="margin-bottom:12px;">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà userId ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ document ID ‡πÄ‡∏õ‡πá‡∏ô userId ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>

  <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:12px;"> <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 3 ‡πÄ‡∏õ‡πá‡∏ô 4 -->
    <div>
      <h4 class="small-muted">üîß Engineer</h4>
      <div id="engineerList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    <div>
      <h4 class="small-muted">üíº Sales</h4>
      <div id="salesList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    <div>
      <h4 class="small-muted">üëî Manager</h4>
      <div id="managerList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    <div> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Admin -->
      <h4 class="small-muted">‚öôÔ∏è Admin</h4>
      <div id="adminList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
  </div>
</section>

    <!-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Worker / Assigner</h3>

      <div class="input-row">
        <select id="nameType" style="width:200px;">
          <option value="workers">‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</option>
          <option value="assigners">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</option>
        </select>
        <input id="newName" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà..." style="flex:1;">
        <button id="addNameBtn" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
      </div>

      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px;">
        <div>
          <h4 class="small-muted">‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (Workers)</h4>
          <div id="workerList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div>
          <h4 class="small-muted">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô (Assigners)</h4>
          <div id="assignerList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
      </div>
    </section>

    <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üè¢ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h3>
      <div id="holidayCalendar"></div>
      <div class="tiny" style="margin-top:8px;">üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö</div>
    </section>

  </div>
</main>

<footer>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö AUTODIDACTIC ‚Äî ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</footer>

<!-- FIREBASE + APP LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /* --------------- Firebase Config --------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyAXayBBLVSohNCIsnlWRq6rD0BUbW70MGk",
    authDomain: "events-666d6.firebaseapp.com",
    projectId: "events-666d6",
    storageBucket: "events-666d6.firebasestorage.app",
    messagingSenderId: "589078390914",
    appId: "1:589078390914:web:480ce96137ffac835aac9b",
    measurementId: "G-97GD75S814"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const $ = id => document.getElementById(id);

  /* --------------- Ensure Default Data --------------- */
  async function ensureDefaultDocs() {
    try {
      const w = await getDocs(collection(db,"workers"));
      if (w.empty) {
        await addDoc(collection(db,"workers"), { name: "User A" });
        await addDoc(collection(db,"workers"), { name: "User B" });
      }
      
      const a = await getDocs(collection(db,"assigners"));
      if (a.empty) await addDoc(collection(db,"assigners"), { name: "Admin" });

      const l = await getDocs(collection(db,"leaves"));
      if (l.empty) {
        await addDoc(collection(db,"leaves"), {
          name: "User A", reason: "‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", start: "2025-01-10", end: "2025-01-10"
        });
      }

      const h = await getDocs(collection(db,"holidays"));
      if (h.empty) {
        await addDoc(collection(db,"holidays"), { name: "‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà", date: "2025-01-01" });
      }

      const e = await getDocs(collection(db,"events"));
      if (e.empty) {
        await addDoc(collection(db,"events"), {
          jobNumber: "JOB-000",
          job: "‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
          location: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà",
          details: "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
          orderDate: "2025-01-01",
          start: "2025-01-01",
          end: "2025-01-02",
          workers: ["User A"],
          assigners: ["Admin"],
          jobTypes: ["‡∏ó‡∏î‡∏™‡∏≠‡∏ö"],
          contactPerson: "Contact",
          phoneNumber: "0000000000",
          status: "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
        });
      }
    } catch(e) {
      console.warn("ensureDefaultDocs failed:", e);
    }
  }

  /* --------------- EVENTS --------------- */
  async function loadEvents() {
    const eventListPending = $("eventListPending");
    const eventListCompleted = $("eventListCompleted");
    
    eventListPending.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
    eventListCompleted.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
    
    const snap = await getDocs(collection(db,"events"));
    
    if(snap.empty) {
      eventListPending.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</i>";
      eventListCompleted.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</i>";
      return;
    }

    eventListPending.innerHTML = "";
    eventListCompleted.innerHTML = "";
    
    let hasPending = false;
    let hasCompleted = false;

    snap.forEach(docSnap => {
      const d = docSnap.data();
      const status = d.status || "";
      
      const createEventElement = () => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:start;">
            <div>
              <strong>${d.jobNumber || "-"}</strong> ‚Äî ${d.location || "-"}<br>
              <span class="small-muted">${(d.jobTypes||[]).join(", ")} ‚Ä¢ ${d.start || "-"} ‚Üí ${d.end || "-"}</span><br>
              <span class="tiny" style="color: ${status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? '#28a745' : status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? '#ffc107' : status === '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' ? '#007bff' : '#dc3545'};">
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}
              </span>
            </div>
            <div style="text-align:right">
              <div class="tiny">${(d.assigners||[]).join(", ")}</div>
              <div class="action-row" style="justify-content:flex-end;">
                <button class="btn" onclick="printEvent('${docSnap.id}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                <button class="btn" onclick="editEvent('${docSnap.id}')">‚úè ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn danger" onclick="deleteEvent('${docSnap.id}')">üóë ‡∏•‡∏ö</button>
              </div>
            </div>
          </div>
        `;
        return div;
      };
      
      // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      if (status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || status === "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") {
        eventListPending.appendChild(createEventElement());
        hasPending = true;
      }
      
      if (status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") {
        eventListCompleted.appendChild(createEventElement());
        hasCompleted = true;
      }
    });
    
    if (!hasPending) {
      eventListPending.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</i>";
    }
    if (!hasCompleted) {
      eventListCompleted.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</i>";
    }
  }

  window.deleteEvent = async (id) => {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    await deleteDoc(doc(db,"events",id));
    loadEvents();
  };

  window.printEvent = async (id) => {
    const snap = await getDoc(doc(db,"events",id));
    const d = snap.data() || {};
    const url = new URL("reportS.html", location.href);
    url.searchParams.set("job", d.jobNumber || d.job || "-");
    url.searchParams.set("start", d.start || "");
    url.searchParams.set("end", d.end || "");
    window.open(url, "_blank");
  };

  window.editEvent = (id) => {
    const url = new URL("edit.html", location.href);
    url.searchParams.set("id", id);
    location.href = url;
  };

  /* --------------- LEAVES --------------- */
  async function loadLeaves() {
    const box = $("leaveList");
    box.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
    const snap = await getDocs(collection(db,"leaves"));
    
    if(snap.empty) {
      box.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡∏≤</i>";
      return;
    }

    box.innerHTML = "";
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `
        <strong>${d.name}</strong> <span class="small-muted">(${d.reason})</span><br>
        <span class="tiny">${d.start} ‚Üí ${d.end}</span>
        <div class="action-row">
          <button class="btn danger" onclick="deleteLeave('${docSnap.id}')">üóë ‡∏•‡∏ö</button>
        </div>
      `;
      box.appendChild(div);
    });
  }

  window.deleteLeave = async (id) => {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    await deleteDoc(doc(db,"leaves",id));
    loadLeaves();
  };

  /* --------------- USERS --------------- */
 async function loadUsers() {
  const engineerBox = $("engineerList");
  const salesBox = $("salesList");
  const managerBox = $("managerList");
  const adminBox = $("adminList"); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  
  engineerBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
  salesBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
  managerBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
  adminBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  
  const snap = await getDocs(collection(db,"users"));
  
  if(snap.empty) {
    engineerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    salesBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    managerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    adminBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>"; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    return;
  }

  engineerBox.innerHTML = "";
  salesBox.innerHTML = "";
  managerBox.innerHTML = "";
  adminBox.innerHTML = ""; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  
  let hasEngineer = false;
  let hasSales = false;
  let hasManager = false;
  let hasAdmin = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

  snap.forEach(d => {
    const v = d.data();
    const name = v.name || "-";
    const password = v.password || "-";
    const userId = v.userId || d.id;
    const position = v.position || "-";

    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <div><b>üë§ ‡∏ä‡∏∑‡πà‡∏≠:</b> ${escapeHtml(name)}</div>
      <div><b>üß∞ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</b> ${escapeHtml(position)}</div>
      <div><b>üÜî UserID:</b> ${escapeHtml(userId)}</div>
      <div><b>üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</b> ${escapeHtml(password)}</div>
      <div class="action-row">
        <button class="btn" onclick="editUserPrompt('${d.id}','${escapeJs(name)}','${escapeJs(password)}','${escapeJs(userId)}','${escapeJs(position)}')">‚úè ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn danger" onclick="deleteUser('${d.id}')">üóë ‡∏•‡∏ö</button>
      </div>
    `;
    
    // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    if (position.toLowerCase() === "engineer") {
      engineerBox.appendChild(div);
      hasEngineer = true;
    } else if (position.toLowerCase() === "sales") {
      salesBox.appendChild(div);
      hasSales = true;
    } else if (position.toLowerCase() === "manager") {
      managerBox.appendChild(div);
      hasManager = true;
    } else if (position.toLowerCase() === "admin") { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ
      adminBox.appendChild(div);
      hasAdmin = true;
    }
  });
  
  if (!hasEngineer) engineerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
  if (!hasSales) salesBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
  if (!hasManager) managerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
  if (!hasAdmin) adminBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>"; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
}

  window.deleteUser = async (id) => {
    if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    await deleteDoc(doc(db,"users",id));
    loadUsers();
  };

  $("addUserBtn").addEventListener("click", async () => {
    const name = $("userName").value.trim();
    const password = $("userPassword").value;
    const position = $("userPosition").value;
    let userId = $("userUserId").value.trim();

    if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (name)");
    if(!password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password)");
    if(!position) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");

    const ref = await addDoc(collection(db,"users"), { 
      name, 
      password,
      position,
      userId: userId || "" 
    });

    if(!userId) {
      await updateDoc(doc(db,"users", ref.id), { userId: ref.id });
    }

    $("userName").value = "";
    $("userPassword").value = "";
    $("userPosition").value = "";
    $("userUserId").value = "";

    loadUsers();
  });

  window.editUserPrompt = async (docId, oldName, oldPassword, oldUserId, oldPosition) => {
    const namePrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠ (name):", decodeURIComponent(oldName));
    if (namePrompt === null) return;
    
    const passPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password):", decodeURIComponent(oldPassword));
    if (passPrompt === null) return;
    
    const positionPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (engineer/sales/manager/admin):", decodeURIComponent(oldPosition));
    if (positionPrompt === null) return;
    
    const uidPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç userId:", decodeURIComponent(oldUserId));
    if (uidPrompt === null) return;

    if (!namePrompt.trim()) return alert("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");
    if (!passPrompt) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");
    if (!positionPrompt.trim()) return alert("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");

    await updateDoc(doc(db,"users", docId), {
      name: namePrompt.trim(),
      password: passPrompt,
      position: positionPrompt.trim(),
      userId: uidPrompt.trim() || docId
    });

    loadUsers();
  };


  window.editUserPrompt = async (docId, oldName, oldPassword, oldUserId, oldPosition) => {
    const namePrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠ (name):", decodeURIComponent(oldName));
    if (namePrompt === null) return;
    
    const passPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password):", decodeURIComponent(oldPassword));
    if (passPrompt === null) return;
    
    const positionPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (engineer/sales/manager/admin):", decodeURIComponent(oldPosition));
    if (positionPrompt === null) return;
    
    const uidPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç userId:", decodeURIComponent(oldUserId));
    if (uidPrompt === null) return;

    if (!namePrompt.trim()) return alert("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");
    if (!passPrompt) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");
    if (!positionPrompt.trim()) return alert("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");

    await updateDoc(doc(db,"users", docId), {
      name: namePrompt.trim(),
      password: passPrompt,
      position: positionPrompt.trim(),
      userId: uidPrompt.trim() || docId
    });

    loadUsers();
  };

  /* --------------- NAMES --------------- */
  async function loadNames() {
    const workerBox = $("workerList");
    const assignerBox = $("assignerList");
    workerBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
    assignerBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

    const wSnap = await getDocs(collection(db,"workers"));
    const aSnap = await getDocs(collection(db,"assigners"));

    workerBox.innerHTML = "";
    assignerBox.innerHTML = "";

    if(wSnap.empty) workerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    wSnap.forEach(d => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `
        ${escapeHtml(d.data().name)}
        <div class="action-row">
          <button class="btn danger" onclick="deleteName('workers','${d.id}')">‚ùå ‡∏•‡∏ö</button>
        </div>
      `;
      workerBox.appendChild(div);
    });

    if(aSnap.empty) assignerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    aSnap.forEach(d => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `
        ${escapeHtml(d.data().name)}
        <div class="action-row">
          <button class="btn danger" onclick="deleteName('assigners','${d.id}')">‚ùå ‡∏•‡∏ö</button>
        </div>
      `;
      assignerBox.appendChild(div);
    });
  }

  window.deleteName = async (col, id) => {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    await deleteDoc(doc(db, col, id));
    loadNames();
  };

  $("addNameBtn").addEventListener("click", async () => {
    const name = $("newName").value.trim();
    const type = $("nameType").value;
    if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
    
    await addDoc(collection(db, type), { name });
    $("newName").value = "";
    loadNames();
  });

  /* --------------- HOLIDAY CALENDAR --------------- */
  async function loadHolidayEvents() {
    const snap = await getDocs(collection(db,"holidays"));
    const arr = [];
    snap.forEach(d => {
      const x = d.data();
      arr.push({ id: d.id, title: x.name, start: x.date, allDay: true });
    });
    return arr;
  }

  async function initHolidayCalendar() {
    const list = await loadHolidayEvents();
    const cal = new FullCalendar.Calendar($("holidayCalendar"), {
      initialView: "dayGridMonth",
      selectable: true,
      events: list,

      dateClick: async (info) => {
        const name = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î:");
        if (!name) return;
        const ref = await addDoc(collection(db,"holidays"), { name, date: info.dateStr });
        cal.addEvent({ id: ref.id, title: name, start: info.dateStr, allDay: true });
      },

      eventClick: async (info) => {
        if (!confirm(`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î "${info.event.title}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
        await deleteDoc(doc(db,"holidays", info.event.id));
        info.event.remove();
      }
    });
    cal.render();
  }

  /* --------------- HELPERS --------------- */
  function escapeHtml(str) {
    if(!str) return "";
    return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function escapeJs(str) {
    if(str === undefined || str === null) return "";
    return encodeURIComponent(String(str));
  }

  /* --------------- INIT --------------- */
  (async () => {
    await ensureDefaultDocs();
    await loadEvents();
    await loadLeaves();
    await loadUsers();
    await loadNames();
    await initHolidayCalendar();
  })();
</script>

</body>
</html>