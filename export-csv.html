<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Export CSV - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</title>
  <style>
    body { font-family: sans-serif; padding: 18px; background:#fff; color:#111; }
    h1 { color:#c00; text-align:left; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
    label { font-weight:600; margin-right:8px; }
    input[type="month"] { padding:6px 8px; border:1px solid #ccc; border-radius:6px; }
    button { background:#c00; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; margin-top:14px; }
    th, td { padding:8px 10px; border:1px solid #e5e5e5; text-align:left; }
    th { background:#f8f8f8; }
    .small { font-size:13px; color:#555; }
    #message { margin-top:12px; color:#555; }
    .manager-btn{
      display:inline-block; margin-bottom:15px; margin-right:10px;
      background:#c00; color:#fff; padding:8px 16px;
      border-radius:8px; text-decoration:none; font-weight:bold;
      box-shadow:0 3px 6px rgba(0,0,0,0.15); transition:0.3s;
    }
    .manager-btn:hover{ background:#a00; }
  </style>
</head>
<body>
  <div>
    <a href="admin.html" class="manager-btn">Back to Admin</a>
  </div>
  <h1>üì• Export CSV ‚Äî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h1>

  <div class="controls">
    <div>
      <label for="startMonth">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <input id="startMonth" type="month" />
    </div>
    <div>
      <label for="endMonth">‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <input id="endMonth" type="month" />
    </div>
    <div>
      <label for="includeZero" class="small">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢</label>
      <input id="includeZero" type="checkbox" checked />
    </div>
    <div>
      <button id="loadBtn">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div>
      <button id="exportBtn" disabled>‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
    </div>
  </div>

  <div id="message" class="small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</div>
  <div id="tableWrap"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCua-GV6L-yz4cQNlSeQwRFNyOvzRQKO9Q",
      authDomain: "events-92057.firebaseapp.com",
      projectId: "events-92057",
      storageBucket: "events-92057.appspot.com",
      messagingSenderId: "33581889849",
      appId: "1:33581889849:web:184cede4ec9f2eb363d0e8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const startMonth = document.getElementById("startMonth");
    const endMonth = document.getElementById("endMonth");
    const includeZeroCheckbox = document.getElementById("includeZero");
    const loadBtn = document.getElementById("loadBtn");
    const exportBtn = document.getElementById("exportBtn");
    const tableWrap = document.getElementById("tableWrap");
    const message = document.getElementById("message");

    let currentReport = [];

    function parseYMD(ymd){
      if(!ymd) return null;
      const parts = ymd.split("-");
      if(parts.length < 3) return null;
      return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }

    function getMonthRange(startStr, endStr){
      const [sy, sm] = startStr.split("-").map(Number);
      const [ey, em] = endStr.split("-").map(Number);
      const start = new Date(sy, sm - 1, 1);
      const end = new Date(ey, em, 1); // exclusive
      return { start, end };
    }

    loadBtn.addEventListener("click", async ()=>{
      const sVal = startMonth.value;
      const eVal = endMonth.value;
      if(!sVal || !eVal){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

      const { start, end } = getMonthRange(sVal, eVal);
      if(start >= end){ alert("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }

      loadBtn.disabled = true;
      exportBtn.disabled = true;
      tableWrap.innerHTML = "";
      message.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

      try{
        const eventsSnap = await getDocs(collection(db,"events"));
        const events = [];
        eventsSnap.forEach(s => {
          const d = s.data();
          d._id = s.id;
          events.push(d);
        });

        const workersSnap = await getDocs(collection(db,"workers"));
        const workers = [];
        workersSnap.forEach(s => {
          const name = s.data().name;
          if(name) workers.push(name);
        });

        const stats = new Map();
        const ensureWorker = name => {
          if(!name) return;
          if(!stats.has(name)) stats.set(name, { name, total:0, finished:0, notFinished:0 });
        };

        if(includeZeroCheckbox.checked){
          workers.forEach(w => ensureWorker(w));
        }

        for(const ev of events){
          const startDate = parseYMD(ev.start);
          if(!startDate) continue;
          if(startDate >= start && startDate < end){
            const workerList = Array.isArray(ev.workers) ? ev.workers : (ev.workers ? [ev.workers] : []);
            for(const w of workerList){
              ensureWorker(w);
              const rec = stats.get(w);
              rec.total++;
              if(ev.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") rec.finished++;
              if(ev.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") rec.notFinished++;
            }
          }
        }

        const rows = Array.from(stats.values()).sort((a,b)=> a.name.localeCompare(b.name,"th"));
        if(rows.length === 0){
          tableWrap.innerHTML = `<div class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
          message.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
          return;
        }

        // ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        const totalSum = rows.reduce((acc, r) => {
          acc.total += r.total;
          acc.finished += r.finished;
          acc.notFinished += r.notFinished;
          return acc;
        }, { total:0, finished:0, notFinished:0 });

        let html = `<table>
          <thead>
            <tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</th><th>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</th><th>‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</th></tr>
          </thead><tbody>`;
        rows.forEach(r=>{
          html += `<tr>
            <td>${r.name}</td>
            <td>${r.total}</td>
            <td>${r.finished}</td>
            <td>${r.notFinished}</td>
          </tr>`;
        });
        html += `<tr style="font-weight:bold;background:#f5f5f5;">
            <td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
            <td>${totalSum.total}</td>
            <td>${totalSum.finished}</td>
            <td>${totalSum.notFinished}</td>
        </tr></tbody></table>`;

        // üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏° (optional)
        html += `<h3 style="margin-top:30px;color:#c00;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>`;
        html += `<ul>`;
        rows.forEach(r=>{
          html += `<li><b>${r.name}</b>: ‡∏£‡∏ß‡∏° ${r.total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${r.finished}, ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${r.notFinished})</li>`;
        });
        html += `</ul>`;

        tableWrap.innerHTML = html;
        message.textContent = `‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏ß‡∏á ${sVal} ‡∏ñ‡∏∂‡∏á ${eVal}`;
        exportBtn.disabled = false;
        currentReport = { rows, totalSum, sVal, eVal };

      }catch(err){
        console.error(err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }finally{
        loadBtn.disabled = false;
      }
    });

   // ‚úÖ Export CSV
exportBtn.addEventListener("click", ()=>{
  if(!currentReport?.rows?.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export");

  const { rows, totalSum, sVal, eVal } = currentReport;
  const header = ["‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô","‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"];
  const lines = [header.join(",")];

  // üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
  rows.forEach(r=>{
    lines.push([
      `"${sVal} ‡∏ñ‡∏∂‡∏á ${eVal}"`,
      `"${r.name}"`,
      r.total,
      r.finished,
      r.notFinished
    ].join(","));
  });

  // üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏ß‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  lines.push(["\"‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\"","",totalSum.total,totalSum.finished,totalSum.notFinished].join(","));

  // üîπ ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ
  lines.push("");
  lines.push("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•");

  // üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
  rows.forEach(r=>{
    lines.push([
      `"${r.name}"`,
      `‡∏£‡∏ß‡∏° ${r.total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`,
      `‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${r.finished}`,
      `‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${r.notFinished}`
    ].join(","));
  });

  // üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
  lines.push("");
  lines.push("üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
  lines.push(`‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,"${sVal} ‡∏ñ‡∏∂‡∏á ${eVal}"`);
  lines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${totalSum.total}`);
  lines.push(`‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢,${totalSum.finished}`);
  lines.push(`‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢,${totalSum.notFinished}`);

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
  const csv = "\uFEFF" + lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô-${sVal}_‡∏ñ‡∏∂‡∏á_${eVal}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});
  </script>
</body>
</html>
